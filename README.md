## OCP Cluster Bootstrap for ACM, GitOps and ZTP
Welcome to my GitHub repository!

This repository serves as the baseline for my lab, encompassing various experiments and setups. Here, you'll find a collection of tools and scripts that form the foundation for my OpenShift testing.

## Table of contents
<!-- TOC -->

<!-- TOC -->

## Prerequisite
- The KVM host is running with [CentOS 9-Stream](https://cloud.centos.org/centos/9-stream/x86_64/images/). Also, we will use it for registry VM.
- In this lab, [mirror registry](https://docs.openshift.com/container-platform/4.13/installing/disconnected_install/installing-mirroring-creating-registry.html#mirror-registry-localhost_installing-mirroring-creating-registry) for Red Hat OpenShift is used. Download mirror-registry.tar.gz.
- Install [oc-mirror](https://docs.openshift.com/container-platform/4.13/installing/disconnected_install/installing-mirroring-creating-registry.html#mirror-registry-localhost_installing-mirroring-creating-registry).

Download CentOS-Stream-GenericCloud-9-20220718.0.x86_64.qcow2 and mirror-registry.tar.gz, and locate them under the git folder.

## Ansible playbooks
Four playbooks are included. \
Those four playbooks drive the bootstrap up to the point that ArgoCD gitops is ready for cluster management. 

| Playbook | Description|
| ---- | --- | 
| baremetal_setup_playbook.yaml | This playbook will configure bridge interface, install and configure libvirt and sushy on the KVM host|
| registry_vm_setup_playbook.yaml | This playbook will launch CentOS VM for the private registry with 500GB disk size on the KVM host.|
| registry_setup_playbook.yaml | This playbook will install mirror-registry into the registry VM with self-signed cert. |
| vm_setup_playbook.yaml | This playbook will launch Openshift cluster based on the image generated by Agent-based-installer. |

Currently I have modifications and manual steps between playbooks in order to make the setup generic and simplified. However, as the lab evolves, my intention is to automate these manual steps to improve reproducibility and eliminate human error. 


## 1. KVM host setup
First step is setting up a KVM host using an Ansible playbook. This playbook will create a bridge interface, install libvirtd and configure Sushy, a tool used to emulate baremetal nodes, by leveraging the containerized Sushy tool based on [Brandon's configuration](https://cloudcult.dev/sushy-emulator-redfish-for-the-virtualization-nation/).

~~~
$ ansible-playbook -i inventry baremetal_setup_playbook.yaml
~~~

## 2. Registry Setup
### 2-1 Cloud-init iso 
To configure access for a CentOS instance using cloud-init, you need to create a cloud-init ISO image containing the necessary user data and meta-data. 

~~~
$ mkisofs -output init.iso -volid cidata -joliet -rock {user-data,meta-data}
~~~

### 2-2 Launch Registry VM
Proceed with setting up a private registry for our clusters. Launch a CentOS VM using the Ansible playbook. 

~~~
$ ansible-playbook -i inventry registry_vm_setup_playbook.yaml
~~~

### 2-2 SSL Certificate Creation
Before configuring the mirror-registry, we need to set up the SSL certificate to secure our private registry. Follow the steps in the instructions under the "ssl" folder.

### 2-3 Configure the mirror-regsitry by Ansible playbook
To install and configure the mirror-registry with SSL certificate, run the Ansible playbook as follows.

~~~
$ ansible-playbook -i inventry registry_setup_playbook.yaml
~~~


## OC Mirror 

## Agent Install setup

## VM setup and Install Cluster 

## Clouster bootstrap 

### Dry run, -K asks password for sudo
ansible-playbook -i inventory baremetal_setup_playbook.yaml --check -K

### Jinja test
ansible all -i "localhost," -c local -m template -a "src=./templates/vm_master.xml.j2 dest=./test.txt" --extra-vars='{"masters": ["master1", "master2", "master3"]}'


### ZTP-pipeline setup
oc patch argocd openshift-gitops -n openshift-gitops --type=merge --patch-file ${ZTP-PIPELINE}/deployment/argocd-openshift-gitops-patch.json