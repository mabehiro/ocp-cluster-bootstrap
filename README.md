## OCP Cluster Bootstrap for ACM, GitOps and ZTP
Welcome to my GitHub repository!

This repository serves as the baseline for my lab, encompassing various experiments and setups. Here, you'll find a collection of tools and scripts that form the foundation for my OpenShift testing.

## Table of contents
<!-- TOC -->

<!-- TOC -->

## Prerequisite
- The KVM host is running with [CentOS 9-Stream](https://cloud.centos.org/centos/9-stream/x86_64/images/). \
Also, we will use it for registry VM.
- In this lab, [mirror registry](https://docs.openshift.com/container-platform/4.13/installing/disconnected_install/installing-mirroring-creating-registry.html#mirror-registry-localhost_installing-mirroring-creating-registry) for Red Hat OpenShift is used. Download mirror-registry.tar.gz.
- Install [oc-mirror](https://docs.openshift.com/container-platform/4.13/installing/disconnected_install/installing-mirroring-creating-registry.html#mirror-registry-localhost_installing-mirroring-creating-registry).

Download CentOS-Stream-GenericCloud-9-20220718.0.x86_64.qcow2 and mirror-registry.tar.gz, and locate them under the git folder.

## Ansible playbooks
Four playbooks are included. \
Those four playbooks drive the bootstrap up to the point that ArgoCD gitops is ready for cluster management. 

| Playbook | Description|
| ---- | --- | 
| baremetal_setup_playbook.yaml | This playbook will configure bridge interface, install and configure libvirt and sushy on the KVM host|
| registry_vm_setup_playbook.yaml | This playbook will launch CentOS VM for the private registry with 500GB disk size on the KVM host.|
| registry_setup_playbook.yaml | This playbook will install mirror-registry into the registry VM with self-signed cert. |
| vm_setup_playbook.yaml | This playbook will launch Openshift cluster based on the image generated by Agent-based-installer. |

Currently I have modifications and manual steps between playbooks in order to make the setup generic and simplified. However, as the lab evolves, my intention is to automate these manual steps to improve reproducibility and eliminate human error. 


## KVM host setup


### about sushy 


## Registry VM setup
Cent OS download

## Private registry instalaltion and config

### Cloud-init
### SSL setup

## OC Mirror 

## Agent Install setup

## VM setup and Install Cluster 

## Clouster bootstrap 

### Dry run, -K asks password for sudo
ansible-playbook -i inventory baremetal_setup_playbook.yaml --check -K

### Jinja test
ansible all -i "localhost," -c local -m template -a "src=./templates/vm_master.xml.j2 dest=./test.txt" --extra-vars='{"masters": ["master1", "master2", "master3"]}'


### ZTP-pipeline setup
oc patch argocd openshift-gitops -n openshift-gitops --type=merge --patch-file ${ZTP-PIPELINE}/deployment/argocd-openshift-gitops-patch.json